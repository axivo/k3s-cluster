---
- name: Role Facts
  ansible.builtin.import_tasks:
    file: facts.yaml

- name: Role Validation
  when: (ansible_run_tags in [(), ('all',)]) or ('helm' in ansible_run_tags)
  run_once: true
  block:
    - name: Validate release key url
      ansible.builtin.uri:
        url: '{{ helm_map.release.key }}'
        timeout: 5
      register: helm_result
      delay: 1
      retries: 3
      until: helm_result is not failed

    - name: Validate release plugins url
      ansible.builtin.uri:
        url: '{{ release.repository.url }}/releases/tag/{{ release.version }}'
        timeout: 5
      loop: '{{ helm_vars.plugins }}'
      loop_control:
        loop_var: release
      register: helm_result
      delay: 1
      retries: 3
      until: helm_result is not failed
      when: release.enabled is truthy
